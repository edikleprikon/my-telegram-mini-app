<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дурак со ставками | Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-color: #ffffff;
            --accent-color: #5682a3;
            --text-color: #333333;
            --button-color: #40a7e3;
            --table-color: #2e7d32;
            --trump-color: #d32f2f;
            --online-color: #4caf50;
            --offline-color: #f44336;
            --waiting-color: #ff9800;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 10px 0;
            background-color: var(--accent-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .game-table {
            background-color: var(--table-color);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .deck-area {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .deck {
            width: 60px;
            height: 90px;
            background-color: #f1c40f;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            color: white;
            font-weight: bold;
        }
        
        .trump-card {
            width: 60px;
            height: 90px;
            background-color: var(--card-color);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid var(--trump-color);
        }
        
        .trump-label {
            color: white;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .card {
            width: 70px;
            height: 100px;
            background-color: var(--card-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            user-select: none;
            position: absolute;
            transition: transform 0.3s;
            font-weight: bold;
        }
        
        .card.red {
            color: #e74c3c;
        }
        
        .card.black {
            color: #2c3e50;
        }
        
        .card-top, .card-bottom {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
        }
        
        .card-center {
            font-size: 24px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .player-hand {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
            min-height: 120px;
        }
        
        .player-hand .card {
            position: relative;
        }
        
        .controls {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        button {
            background-color: var(--button-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        button:hover {
            background-color: #2c90c9;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .betting-panel {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .balance {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            height: 24px;
        }
        
        .card-back {
            background: repeating-linear-gradient(
                45deg,
                #2c3e50,
                #2c3e50 10px,
                #34495e 10px,
                #34495e 20px
            );
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        
        .opponent-area {
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            flex-direction: column;
        }
        
        .opponent-cards {
            display: flex;
        }
        
        .opponent-card {
            width: 40px;
            height: 60px;
            background: repeating-linear-gradient(
                45deg,
                #2c3e50,
                #2c3e50 10px,
                #34495e 10px,
                #34495e 20px
            );
            border-radius: 5px;
            margin: 0 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .multiplayer-panel {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mode-selector {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .mode-button {
            padding: 15px 25px;
            font-size: 18px;
        }
        
        .online-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: var(--online-color);
        }
        
        .status-offline {
            background-color: var(--offline-color);
        }
        
        .status-waiting {
            background-color: var(--waiting-color);
        }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .player-item {
            display: flex;
            align-items: center;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        
        .waiting-room {
            text-align: center;
            padding: 20px;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--button-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chat-container {
            margin-top: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chat-messages {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .chat-input {
            display: flex;
        }
        
        .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
        }
        
        .chat-input button {
            border-radius: 0 5px 5px 0;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .message.self {
            background-color: #e3f2fd;
            text-align: right;
        }
        
        .message-time {
            font-size: 12px;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Дурак со ставками</h1>
    </div>
    
    <div class="container">
        <div class="balance">
            Баланс: <span id="balance">1000</span> ₽
        </div>
        
        <div class="player-info">
            <div class="player-item">
                <div class="player-avatar" id="player-avatar">Я</div>
                <div>
                    <div>Вы</div>
                    <div id="player-cards">Карт: 0</div>
                </div>
            </div>
            <div class="player-item">
                <div class="player-avatar" id="opponent-avatar">?</div>
                <div>
                    <div id="opponent-name">Ожидание...</div>
                    <div id="opponent-cards-count">Карт: 0</div>
                </div>
            </div>
        </div>
        
        <div class="mode-selector">
            <button class="mode-button" onclick="selectMode('single')">Играть с ботом</button>
            <button class="mode-button" onclick="selectMode('multiplayer')">Играть с другом</button>
        </div>
        
        <div id="betting-panel" class="betting-panel">
            <h2>Сделайте ставку</h2>
            <div>
                <button onclick="changeBet(-50)">-50</button>
                <button onclick="changeBet(-10)">-10</button>
                <span id="current-bet" style="margin: 0 15px; font-size: 20px;">50</span> ₽
                <button onclick="changeBet(10)">+10</button>
                <button onclick="changeBet(50)">+50</button>
            </div>
            <button onclick="startGame()" style="margin-top: 15px; padding: 15px 30px;">Играть</button>
        </div>
        
        <div id="multiplayer-panel" class="multiplayer-panel" style="display: none;">
            <h2>Мультиплеер</h2>
            <div class="online-status">
                <div class="status-dot" id="connection-status"></div>
                <span id="connection-text">Подключение...</span>
            </div>
            
            <div id="room-creation" style="margin: 20px 0;">
                <button onclick="createRoom()">Создать комнату</button>
                <div style="margin: 15px 0;">или</div>
                <div style="display: flex;">
                    <input type="text" id="room-id-input" placeholder="ID комнаты" style="flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px 0 0 5px;">
                    <button onclick="joinRoom()" style="border-radius: 0 5px 5px 0;">Присоединиться</button>
                </div>
            </div>
            
            <div id="waiting-room" class="waiting-room" style="display: none;">
                <h3>Ожидание соперника</h3>
                <div class="loader"></div>
                <p>ID комнаты: <strong id="room-id"></strong></p>
                <p>Поделитесь этим ID с другом</p>
                <button onclick="cancelWaiting()">Отмена</button>
            </div>
        </div>
        
        <div id="game-container" style="display: none;">
            <div class="game-status" id="game-status">Ваш ход</div>
            
            <div class="opponent-area">
                <div id="opponent-info"></div>
                <div class="opponent-cards" id="opponent-cards">
                    <!-- Карты противника будут отображаться здесь -->
                </div>
            </div>
            
            <div class="game-table" id="game-table">
                <div class="deck-area">
                    <div class="deck" id="deck">
                        <span id="deck-count">36</span>
                    </div>
                    <div class="trump-card" id="trump-card"></div>
                    <div class="trump-label">Козырь</div>
                </div>
                <!-- Карты на столе будут отображаться здесь -->
            </div>
            
            <div class="player-hand" id="player-hand">
                <!-- Карты игрока -->
            </div>
            
            <div class="controls">
                <button id="take-button" onclick="takeCards()">Взять</button>
                <button id="pass-button" onclick="passTurn()">Бито</button>
            </div>
            
            <div class="chat-container" id="chat-container">
                <h3>Чат</h3>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Введите сообщение...">
                    <button onclick="sendMessage()">Отпр.</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Получаем данные пользователя
        const user = tg.initDataUnsafe?.user;
        if (user) {
            document.getElementById('player-avatar').textContent = user.first_name ? user.first_name[0] : 'И';
        }
        
        // Игровые переменные
        let balance = 1000;
        let currentBet = 50;
        let deck = [];
        let playerHand = [];
        let opponentHand = [];
        let tableCards = [];
        let trumpCard = null;
        let isPlayerTurn = true;
        let deckCount = 36;
        let gameMode = 'single'; // 'single' или 'multiplayer'
        let roomId = null;
        let opponent = null;
        let connectionStatus = 'disconnected';
        
        // Симуляция WebSocket соединения (в реальном приложении нужно использовать WebSocket)
        let websocketSimulator = {
            connect: function() {
                setConnectionStatus('connecting');
                // Имитация подключения
                setTimeout(() => {
                    setConnectionStatus('connected');
                    // Имитация получения списка доступных комнат
                    simulateWebSocketMessage({ type: 'rooms_list', rooms: [] });
                }, 1000);
            },
            createRoom: function() {
                setConnectionStatus('waiting');
                // Генерируем случайный ID комнаты
                roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                document.getElementById('room-id').textContent = roomId;
                document.getElementById('room-creation').style.display = 'none';
                document.getElementById('waiting-room').style.display = 'block';
                
                // Имитация ожидания противника
                setTimeout(() => {
                    // Имитация подключения противника
                    opponent = {
                        id: 'opponent_123',
                        first_name: 'Друг',
                        username: 'friend'
                    };
                    
                    document.getElementById('opponent-avatar').textContent = opponent.first_name ? opponent.first_name[0] : 'Д';
                    document.getElementById('opponent-name').textContent = opponent.first_name || 'Игрок';
                    
                    // Имитация начала игры
                    simulateWebSocketMessage({ 
                        type: 'game_start', 
                        opponent: opponent,
                        room: roomId
                    });
                }, 3000);
            },
            joinRoom: function(roomId) {
                setConnectionStatus('connecting');
                // Имитация подключения к комнате
                setTimeout(() => {
                    setConnectionStatus('connected');
                    
                    // Имитация успешного подключения к комнате
                    opponent = {
                        id: 'host_123',
                        first_name: 'Хост',
                        username: 'host'
                    };
                    
                    document.getElementById('opponent-avatar').textContent = opponent.first_name ? opponent.first_name[0] : 'Х';
                    document.getElementById('opponent-name').textContent = opponent.first_name || 'Хост';
                    
                    // Имитация начала игры
                    simulateWebSocketMessage({ 
                        type: 'game_start', 
                        opponent: opponent,
                        room: roomId
                    });
                }, 2000);
            },
            sendMessage: function(message) {
                // Имитация отправки сообщения
                console.log('Отправка сообщения:', message);
                // Имитация получения сообщения
                setTimeout(() => {
                    simulateWebSocketMessage({
                        type: 'message',
                        from: opponent.id,
                        text: message.text,
                        timestamp: Date.now()
                    });
                }, 500);
            },
            makeMove: function(move) {
                // Имитация отправки хода
                console.log('Отправка хода:', move);
                // Имитация получения хода противника
                setTimeout(() => {
                    simulateWebSocketMessage({
                        type: 'move',
                        from: opponent.id,
                        move: simulateOpponentMove()
                    });
                }, 2000);
            }
        };
        
        function simulateWebSocketMessage(message) {
            switch (message.type) {
                case 'rooms_list':
                    console.log('Получен список комнат:', message.rooms);
                    break;
                case 'game_start':
                    console.log('Игра началась с', message.opponent);
                    startMultiplayerGame(message.opponent);
                    break;
                case 'move':
                    console.log('Получен ход от противника:', message.move);
                    handleOpponentMove(message.move);
                    break;
                case 'message':
                    console.log('Получено сообщение:', message);
                    addMessageToChat(message.from, message.text, message.timestamp, false);
                    break;
                case 'error':
                    console.error('Ошибка:', message.error);
                    alert('Ошибка: ' + message.error);
                    break;
            }
        }
        
        function setConnectionStatus(status) {
            connectionStatus = status;
            const statusDot = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            statusDot.className = 'status-dot';
            switch(status) {
                case 'disconnected':
                    statusDot.classList.add('status-offline');
                    statusText.textContent = 'Отключено';
                    break;
                case 'connecting':
                    statusDot.classList.add('status-waiting');
                    statusText.textContent = 'Подключение...';
                    break;
                case 'connected':
                    statusDot.classList.add('status-online');
                    statusText.textContent = 'Подключено';
                    break;
                case 'waiting':
                    statusDot.classList.add('status-waiting');
                    statusText.textContent = 'Ожидание соперника...';
                    break;
            }
        }
        
        function selectMode(mode) {
            gameMode = mode;
            if (mode === 'single') {
                document.getElementById('multiplayer-panel').style.display = 'none';
                document.getElementById('betting-panel').style.display = 'block';
            } else {
                document.getElementById('betting-panel').style.display = 'none';
                document.getElementById('multiplayer-panel').style.display = 'block';
                websocketSimulator.connect();
            }
        }
        
        function createRoom() {
            websocketSimulator.createRoom();
        }
        
        function joinRoom() {
            const roomId = document.getElementById('room-id-input').value.trim();
            if (roomId) {
                websocketSimulator.joinRoom(roomId);
            } else {
                alert('Введите ID комнаты');
            }
        }
        
        function cancelWaiting() {
            document.getElementById('waiting-room').style.display = 'none';
            document.getElementById('room-creation').style.display = 'block';
            setConnectionStatus('connected');
        }
        
        function startMultiplayerGame(opponentPlayer) {
            opponent = opponentPlayer;
            document.getElementById('multiplayer-panel').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('chat-container').style.display = 'block';
            
            // Начинаем игру
            startGame();
        }
        
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (text) {
                // Добавляем сообщение в чат
                addMessageToChat('self', text, Date.now(), true);
                
                // Отправляем сообщение через WebSocket
                websocketSimulator.sendMessage({
                    type: 'message',
                    text: text,
                    timestamp: Date.now()
                });
                
                // Очищаем поле ввода
                input.value = '';
            }
        }
        
        function addMessageToChat(sender, text, timestamp, isSelf) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSelf ? 'self' : ''}`;
            
            const time = new Date(timestamp).toLocaleTimeString();
            const senderName = isSelf ? 'Вы' : (opponent?.first_name || 'Оппонент');
            
            messageDiv.innerHTML = `
                <div><strong>${senderName}:</strong> ${text}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Обновление интерфейса
        function updateBalance() {
            document.getElementById('balance').textContent = balance;
        }
        
        function changeBet(amount) {
            currentBet += amount;
            if (currentBet < 10) currentBet = 10;
            if (currentBet > balance) currentBet = balance;
            document.getElementById('current-bet').textContent = currentBet;
        }
        
        // Инициализация игры
        function startGame() {
            if (currentBet > balance) {
                alert('Недостаточно средств!');
                return;
            }
            
            // Скрываем панель ставок, показываем игровое поле
            document.getElementById('betting-panel').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            
            // Скрываем чат в одиночной игре
            if (gameMode === 'single') {
                document.getElementById('chat-container').style.display = 'none';
            }
            
            // Создаем колоду
            initializeDeck();
            shuffleDeck();
            
            // Раздаем карты
            dealCards();
            
            // Определяем козырь
            trumpCard = deck.pop();
            deckCount--;
            
            // Обновляем интерфейс
            updateDeckDisplay();
            renderGame();
            
            // Определяем кто ходит первым
            determineFirstTurn();
        }
        
        function initializeDeck() {
            const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
            const ranks = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            
            deck = [];
            for (let suit of suits) {
                for (let rank of ranks) {
                    deck.push({ suit, rank });
                }
            }
            
            deckCount = 36;
        }
        
        function shuffleDeck() {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }
        
        function dealCards() {
            playerHand = [];
            opponentHand = [];
            
            for (let i = 0; i < 6; i++) {
                if (deck.length > 0) {
                    playerHand.push(deck.pop());
                    deckCount--;
                }
                if (deck.length > 0) {
                    opponentHand.push(deck.pop());
                    deckCount--;
                }
            }
            
            updateOpponentCardsDisplay();
            updatePlayerCardsCount();
        }
        
        function determineFirstTurn() {
            // Определяем кто ходит первым - у кого младший козырь
            let playerLowestTrump = findLowestTrump(playerHand);
            let opponentLowestTrump = findLowestTrump(opponentHand);
            
            if (!playerLowestTrump && !opponentLowestTrump) {
                // Если козырей ни у кого нет, определяем случайно
                isPlayerTurn = Math.random() > 0.5;
            } else if (!playerLowestTrump) {
                isPlayerTurn = false;
            } else if (!opponentLowestTrump) {
                isPlayerTurn = true;
            } else {
                // Сравниваем младшие козыри
                isPlayerTurn = getCardValue(playerLowestTrump) < getCardValue(opponentLowestTrump);
            }
            
            updateGameStatus();
            
            if (!isPlayerTurn) {
                if (gameMode === 'single') {
                    setTimeout(botTurn, 1500);
                } else {
                    // В multiplayer ждем ход противника
                    document.getElementById('game-status').textContent = 'Ход противника';
                }
            }
        }
        
        function findLowestTrump(hand) {
            const trumps = hand.filter(card => card.suit === trumpCard.suit);
            if (trumps.length === 0) return null;
            
            return trumps.reduce((lowest, card) => {
                if (!lowest) return card;
                return getCardValue(card) < getCardValue(lowest) ? card : lowest;
            }, null);
        }
        
        function updateDeckDisplay() {
            document.getElementById('deck-count').textContent = deckCount;
            
            const trumpElement = document.getElementById('trump-card');
            trumpElement.innerHTML = `
                <div class="card-top">${getRankSymbol(trumpCard.rank)}${getSuitSymbol(trumpCard.suit)}</div>
                <div class="card-center">${getSuitSymbol(trumpCard.suit)}</div>
                <div class="card-bottom">${getRankSymbol(trumpCard.rank)}${getSuitSymbol(trumpCard.suit)}</div>
            `;
            
            if (trumpCard.suit === 'hearts' || trumpCard.suit === 'diamonds') {
                trumpElement.classList.add('red');
                trumpElement.classList.remove('black');
            } else {
                trumpElement.classList.add('black');
                trumpElement.classList.remove('red');
            }
        }
        
        function updateOpponentCardsDisplay() {
            const opponentCardsElement = document.getElementById('opponent-cards');
            opponentCardsElement.innerHTML = '';
            
            for (let i = 0; i < opponentHand.length; i++) {
                const cardElement = document.createElement('div');
                cardElement.className = 'opponent-card';
                opponentCardsElement.appendChild(cardElement);
            }
            
            document.getElementById('opponent-cards-count').textContent = `Карт: ${opponentHand.length}`;
        }
        
        function updatePlayerCardsCount() {
            document.getElementById('player-cards').textContent = `Карт: ${playerHand.length}`;
        }
        
        function updateGameStatus() {
            const statusElement = document.getElementById('game-status');
            statusElement.textContent = isPlayerTurn ? 'Ваш ход' : 'Ход противника';
        }
        
        function renderGame() {
            // Очищаем игровое поле
            const gameTable = document.getElementById('game-table');
            // Сохраняем область колоды
            const deckArea = document.querySelector('.deck-area');
            gameTable.innerHTML = '';
            gameTable.appendChild(deckArea);
            
            // Отображаем карты на столе
            tableCards.forEach((card, index) => {
                const cardElement = createCardElement(card);
                cardElement.style.left = `${150 + index * 40}px`;
                cardElement.style.top = `${100 - Math.floor(index / 6) * 30}px`;
                cardElement.onclick = null;
                gameTable.appendChild(cardElement);
            });
            
            // Отображаем карты игрока
            const playerHandElement = document.getElementById('player-hand');
            playerHandElement.innerHTML = '';
            
            playerHand.forEach((card, index) => {
                const cardElement = createCardElement(card);
                cardElement.style.position = 'relative';
                cardElement.onclick = () => playCard(index);
                playerHandElement.appendChild(cardElement);
            });
            
            updateOpponentCardsDisplay();
            updatePlayerCardsCount();
            updateDeckDisplay();
            updateGameStatus();
        }
        
        function createCardElement(card) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            cardElement.innerHTML = `
                <div class="card-top">${getRankSymbol(card.rank)}${getSuitSymbol(card.suit)}</div>
                <div class="card-center">${getSuitSymbol(card.suit)}</div>
                <div class="card-bottom">${getRankSymbol(card.rank)}${getSuitSymbol(card.suit)}</div>
            `;
            
            if (card.suit === 'hearts' || card.suit === 'diamonds') {
                cardElement.classList.add('red');
                cardElement.classList.remove('black');
            } else {
                cardElement.classList.add('black');
                cardElement.classList.remove('red');
            }
            
            return cardElement;
        }
        
        function getSuitSymbol(suit) {
            const symbols = {
                'hearts': '♥',
                'diamonds': '♦',
                'clubs': '♣',
                'spades': '♠'
            };
            return symbols[suit] || '';
        }
        
        function getRankSymbol(rank) {
            return rank;
        }
        
        function playCard(cardIndex) {
            if (!isPlayerTurn) return;
            
            const card = playerHand[cardIndex];
            let canPlay = false;
            
            if (tableCards.length === 0) {
                // Первый ход - можно ходить любой картой
                canPlay = true;
            } else if (tableCards.length % 2 === 0) {
                // Атака - можно ходить любой картой того же достоинства, что уже есть на столе
                canPlay = tableCards.some(tableCard => tableCard.rank === card.rank);
            } else {
                // Защита - нужно побить карту
                canPlay = canBeat(card, tableCards[tableCards.length - 1]);
            }
            
            if (canPlay) {
                tableCards.push(card);
                playerHand.splice(cardIndex, 1);
                isPlayerTurn = false;
                
                // Добираем карту из колоды, если есть
                if (deck.length > 0) {
                    playerHand.push(deck.pop());
                    deckCount--;
                }
                
                renderGame();
                
                if (gameMode === 'single') {
                    // Ход бота
                    setTimeout(botTurn, 1000);
                } else {
                    // Отправляем ход противнику
                    websocketSimulator.makeMove({
                        type: 'move',
                        card: card,
                        table: tableCards
                    });
                    
                    updateGameStatus();
                }
                
                checkGameEnd();
            }
        }
        
        function canBeat(attackingCard, defendingCard) {
            // Проверяем, может ли карта побить другую карту
            const trumpSuit = trumpCard.suit;
            
            if (attackingCard.suit === defendingCard.suit) {
                return getCardValue(attackingCard) > getCardValue(defendingCard);
            } else if (attackingCard.suit === trumpSuit) {
                return true;
            }
            
            return false;
        }
        
        function getCardValue(card) {
            const values = {
                '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
                'J': 11, 'Q': 12, 'K': 13, 'A': 14
            };
            return values[card.rank] || 0;
        }
        
        function botTurn() {
            updateGameStatus();
            
            let botPlayed = false;
            
            if (tableCards.length === 0) {
                // Бот ходит first - выбирает случайную карту
                if (opponentHand.length > 0) {
                    const cardToPlay = opponentHand[0];
                    tableCards.push(cardToPlay);
                    opponentHand.splice(0, 1);
                    botPlayed = true;
                }
            } else if (tableCards.length % 2 === 0) {
                // Бот атакует - ищет карты того же достоинства, что на столе
                for (let card of opponentHand) {
                    if (tableCards.some(tableCard => tableCard.rank === card.rank)) {
                        tableCards.push(card);
                        opponentHand.splice(opponentHand.indexOf(card), 1);
                        botPlayed = true;
                        break;
                    }
                }
            } else {
                // Бот защищается - пытается побить карту
                const cardToBeat = tableCards[tableCards.length - 1];
                for (let card of opponentHand) {
                    if (canBeat(card, cardToBeat)) {
                        tableCards.push(card);
                        opponentHand.splice(opponentHand.indexOf(card), 1);
                        botPlayed = true;
                        break;
                    }
                }
                
                if (!botPlayed) {
                    // Бот берет карты
                    tableCards.forEach(card => opponentHand.push(card));
                    tableCards = [];
                }
            }
            
            // Добираем карту из колоды, если есть
            if (botPlayed && deck.length > 0) {
                opponentHand.push(deck.pop());
                deckCount--;
            }
            
            isPlayerTurn = !botPlayed || tableCards.length % 2 === 1;
            renderGame();
            checkGameEnd();
            
            if (!isPlayerTurn && tableCards.length > 0) {
                setTimeout(botTurn, 1000);
            }
        }
        
        function simulateOpponentMove() {
            // Имитация хода противника в multiplayer
            // В реальном приложении это будет приходить с сервера
            let move = null;
            
            if (tableCards.length === 0) {
                // Противник ходит first - выбирает случайную карту
                if (opponentHand.length > 0) {
                    const cardToPlay = opponentHand[0];
                    tableCards.push(cardToPlay);
                    opponentHand.splice(0, 1);
                    move = { type: 'attack', card: cardToPlay };
                }
            } else if (tableCards.length % 2 === 0) {
                // Противник атакует - ищет карты того же достоинства, что на столе
                for (let card of opponentHand) {
                    if (tableCards.some(tableCard => tableCard.rank === card.rank)) {
                        tableCards.push(card);
                        opponentHand.splice(opponentHand.indexOf(card), 1);
                        move = { type: 'attack', card: card };
                        break;
                    }
                }
            } else {
                // Противник защищается - пытается побить карту
                const cardToBeat = tableCards[tableCards.length - 1];
                for (let card of opponentHand) {
                    if (canBeat(card, cardToBeat)) {
                        tableCards.push(card);
                        opponentHand.splice(opponentHand.indexOf(card), 1);
                        move = { type: 'defend', card: card, against: cardToBeat };
                        break;
                    }
                }
                
                if (!move) {
                    // Противник берет карты
                    tableCards.forEach(card => opponentHand.push(card));
                    tableCards = [];
                    move = { type: 'take' };
                }
            }
            
            // Добираем карту из колоды, если есть
            if (move && move.type !== 'take' && deck.length > 0) {
                opponentHand.push(deck.pop());
                deckCount--;
            }
            
            isPlayerTurn = true;
            return move;
        }
        
        function handleOpponentMove(move) {
            // Обработка хода противника в multiplayer
            renderGame();
            checkGameEnd();
        }
        
        function takeCards() {
            // Игрок берет карты
            tableCards.forEach(card => playerHand.push(card));
            tableCards = [];
            isPlayerTurn = false;
            
            renderGame();
            
            if (gameMode === 'single') {
                setTimeout(botTurn, 1000);
            } else {
                // Отправляем уведомление о взятии карт
                websocketSimulator.makeMove({
                    type: 'take'
                });
                
                updateGameStatus();
            }
        }
        
        function passTurn() {
            // Игрок говорит "Бито"
            tableCards = [];
            isPlayerTurn = false;
            
            // Добираем карты
            while (playerHand.length < 6 && deck.length > 0) {
                playerHand.push(deck.pop());
                deckCount--;
            }
            
            while (opponentHand.length < 6 && deck.length > 0) {
                opponentHand.push(deck.pop());
                deckCount--;
            }
            
            renderGame();
            
            if (gameMode === 'single') {
                setTimeout(botTurn, 1000);
            } else {
                // Отправляем уведомление о пасе
                websocketSimulator.makeMove({
                    type: 'pass'
                });
                
                updateGameStatus();
            }
        }
        
        function checkGameEnd() {
            if (playerHand.length === 0 && opponentHand.length === 0 && deck.length === 0) {
                // Ничья
                endGame(null);
            } else if (playerHand.length === 0 && deck.length === 0) {
                // Игрок выиграл
                endGame(true);
            } else if (opponentHand.length === 0 && deck.length === 0) {
                // Противник выиграл
                endGame(false);
            }
        }
        
        function endGame(playerWon) {
            if (playerWon === true) {
                balance += currentBet;
                alert('Вы выиграли! +' + currentBet + '₽');
            } else if (playerWon === false) {
                balance -= currentBet;
                alert('Вы проиграли! -' + currentBet + '₽');
            } else {
                alert('Ничья! Ставка возвращена.');
            }
            
            updateBalance();
            
            // Возвращаем к панели выбора режима
            document.getElementById('game-container').style.display = 'none';
            
            if (gameMode === 'single') {
                document.getElementById('betting-panel').style.display = 'block';
            } else {
                document.getElementById('multiplayer-panel').style.display = 'block';
                document.getElementById('waiting-room').style.display = 'none';
                document.getElementById('room-creation').style.display = 'block';
                setConnectionStatus('connected');
            }
            
            // Если баланс нулевой, предлагаем начать заново
            if (balance <= 0) {
                if (confirm('Ваш баланс опустился до нуля. Начать заново?')) {
                    balance = 1000;
                    updateBalance();
                }
            }
        }
        
        // Инициализация при загрузке
        updateBalance();
    </script>
</body>
</html>
